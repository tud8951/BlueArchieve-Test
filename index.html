<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/favicon.ico" >
    <title>BAæŠ½å¡æ¨¡æ‹Ÿå™¨-çœŸå®ç‰ˆ</title>
    <style>
        /* æ‰‹æœºç«¯æµ‹è¯•æ ·å¼ */
        @media (max-width: 768px) {
            .gacha-left {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: absolute !important;
                left: -9999px !important;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: url('https://via.placeholder.com/1920x1080/4a6da7/ffffff?text=BA+Background');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #4a6da7;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .gacha-banner {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #4a6da7, #8ab4f8);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .gacha-banner::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://via.placeholder.com/100x100/ffffff/4a6da7?text=BA') center/contain no-repeat;
            opacity: 0.1;
        }
        
        .gacha-banner h2 {
            color: white;
            font-size: 2rem;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #singlePull {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
        }
        
        #multiPull {
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            color: white;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            height: 200px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: scale(0.8);
            animation: cardAppear 0.5s forwards;
        }
        
        @keyframes cardAppear {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .card-image {
            height: 70%;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .card-rarity {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }
        
        .rarity-3 {
            background: linear-gradient(135deg, #ffd700, #ff9800);
        }
        
        .rarity-2 {
            background: linear-gradient(135deg, #b39ddb, #7e57c2);
        }
        
        .rarity-1 {
            background: linear-gradient(135deg, #a5d6a7, #4caf50);
        }
        
        .card-info {
            padding: 10px;
            text-align: center;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .card-name {
            font-weight: bold;
            margin-bottom: 3px;
            color: #4a6da7;
        }
        
        .card-type {
            font-size: 0.8rem;
            color: #666;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(74, 109, 167, 0.1);
            border-radius: 10px;
        }
        
        .stat-box {
            text-align: center;
            padding: 10px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a6da7;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4a6da7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .new-student {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ff4081;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* ç”»æ¿æ ·å¼ */
        .drawing-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 101;
            flex-direction: column;
        }

        .drawing-container {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .drawing-title {
            text-align: center;
            margin-bottom: 20px;
            color: #4a6da7;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .drawing-instruction {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .drawing-canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        canvas {
            border: 3px solid #4a6da7;
            border-radius: 10px;
            background-color: white;
            cursor: crosshair;
            box-shadow: 0 4px 12px rgba(74, 109, 167, 0.2);
        }

        .drawing-tools {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: #4a6da7;
            transform: scale(1.1);
        }

        .brush-size {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brush-size input {
            width: 100px;
        }

        .drawing-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .drawing-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .drawing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #finishDrawing {
            background: linear-gradient(135deg, #4a6da7, #8ab4f8);
            color: white;
        }

        #cancelDrawing {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
        }

        #clearCanvas {
            background: linear-gradient(135deg, #a5d6a7, #4caf50);
            color: white;
        }

        .drawing-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
            max-width: 200px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            h1 {
                font-size: 2rem;
                margin-bottom: 15px;
            }
            
            .results {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .card {
                height: 160px;
            }
            
            .card-name {
                font-size: 0.9rem;
            }
            
            .card-type {
                font-size: 0.7rem;
            }
            
            .stats {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stat-box {
                flex: 1;
                min-width: 120px;
                padding: 8px;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }

            .drawing-container {
                width: 95%;
                padding: 15px;
            }

            canvas {
                width: 100%;
                height: auto;
                max-width: 400px;
                max-height: 300px;
            }
            
            .drawing-tools {
                flex-direction: column;
                gap: 10px;
            }
            
            .drawing-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .drawing-btn {
                width: 100%;
            }
            
            /* é¡¶éƒ¨æ ä¼˜åŒ– */
            .top-bar {
                height: 44px;
                padding: 0 16px;
                font-size: 1rem;
            }
            
            .top-bar .point-box {
                padding: 3px 8px;
                font-size: 0.8rem;
            }
            
            /* ä¸»å†…å®¹åŒºä¼˜åŒ– - æ‰‹æœºç‰ˆç®€åŒ– */
            .gacha-main {
                margin: 20px auto 0 auto;
                min-height: auto;
                flex-direction: column;
            }
            
            .gacha-left {
                display: none !important; /* éšè—è§’è‰²å¤§å›¾å’Œåˆ‡æ¢æŒ‰é’® */
            }
            
            .gacha-arrow {
                display: none !important; /* éšè—åˆ‡æ¢ç®­å¤´ */
            }
            
            .gacha-character {
                display: none !important; /* éšè—è§’è‰²å¡ç‰‡ */
            }
            
            .gacha-right {
                margin-left: 0;
                margin-top: 0;
                min-width: auto;
                width: 100%;
                padding: 20px;
                text-align: center;
            }
            
            .event-title {
                font-size: 1.8rem;
                margin-bottom: 15px;
            }
            
            .event-time {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .event-highlight {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .event-desc {
                font-size: 1rem;
                line-height: 1.6;
            }
            
            /* åº•éƒ¨æŒ‰é’®ä¼˜åŒ– */
            .gacha-bottom {
                margin: 20px auto 0 auto;
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .point-box {
                padding: 6px 12px;
                font-size: 1rem;
            }
            
            .gacha-btn {
                font-size: 1rem;
                padding: 10px 20px;
                margin: 0 2px;
            }
            
            /* å¼¹çª—ä¼˜åŒ– */
            .gacha-result-content {
                padding: 20px;
                min-width: 280px;
                max-width: 95vw;
            }
            
            .gacha-result-title {
                font-size: 1.3rem;
            }
            
            .gacha-result-cards {
                gap: 12px;
            }
            
            .gacha-result-card {
                width: 90px;
                padding: 6px;
            }
            
            .gacha-result-card img {
                width: 60px;
                height: 60px;
            }
            
            .gacha-result-card .name {
                font-size: 0.9rem;
            }
            
            .gacha-result-card .type {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .results {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .card {
                height: 140px;
            }
            
            .card-name {
                font-size: 0.8rem;
            }
            
            .card-type {
                font-size: 0.6rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-box {
                min-width: auto;
                padding: 6px;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
            
            .drawing-container {
                padding: 10px;
            }
            
            .drawing-title {
                font-size: 1.3rem;
            }
            
            .drawing-instruction {
                font-size: 0.9rem;
            }
            
            /* é¡¶éƒ¨æ è¿›ä¸€æ­¥ä¼˜åŒ– */
            .top-bar {
                height: 40px;
                padding: 0 12px;
                font-size: 0.9rem;
            }
            
            .top-bar .point-box {
                padding: 2px 6px;
                font-size: 0.7rem;
            }
            
            /* ä¸»å†…å®¹åŒºè¿›ä¸€æ­¥ä¼˜åŒ– */
            .gacha-main {
                margin: 15px auto 0 auto;
            }
            
            .gacha-left {
                display: none !important; /* ç¡®ä¿å°å±å¹•ä¹Ÿéšè—è§’è‰²å¤§å›¾ */
            }
            
            .gacha-arrow {
                display: none !important; /* éšè—åˆ‡æ¢ç®­å¤´ */
            }
            
            .gacha-character {
                display: none !important; /* éšè—è§’è‰²å¡ç‰‡ */
            }
            
            .gacha-right {
                padding: 15px;
            }
            
            .event-title {
                font-size: 1.6rem;
            }
            
            .event-time {
                font-size: 0.9rem;
            }
            
            .event-highlight {
                font-size: 1.1rem;
            }
            
            .event-desc {
                font-size: 0.9rem;
            }
            
            /* åº•éƒ¨æŒ‰é’®è¿›ä¸€æ­¥ä¼˜åŒ– */
            .gacha-bottom {
                margin: 15px auto 0 auto;
                gap: 8px;
            }
            
            .point-box {
                padding: 5px 10px;
                font-size: 0.9rem;
            }
            
            .gacha-btn {
                font-size: 0.9rem;
                padding: 8px 16px;
                margin: 0 1px;
            }
            
            /* å¼¹çª—è¿›ä¸€æ­¥ä¼˜åŒ– */
            .gacha-result-content {
                padding: 15px;
                min-width: 260px;
            }
            
            .gacha-result-title {
                font-size: 1.2rem;
            }
            
            .gacha-result-cards {
                gap: 8px;
            }
            
            .gacha-result-card {
                width: 80px;
                padding: 5px;
            }
            
            .gacha-result-card img {
                width: 50px;
                height: 50px;
            }
            
            .gacha-result-card .name {
                font-size: 0.8rem;
            }
            
            .gacha-result-card .type {
                font-size: 0.7rem;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .results {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .stats {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .gacha-bottom {
                flex-direction: column;
                gap: 6px;
            }
            
            .gacha-btn {
                width: 100%;
                margin: 0;
            }
            
            .gacha-left {
                display: none !important; /* ç¡®ä¿è¶…å°å±å¹•ä¹Ÿéšè—è§’è‰²å¤§å›¾ */
            }
            
            .gacha-arrow {
                display: none !important; /* éšè—åˆ‡æ¢ç®­å¤´ */
            }
            
            .gacha-character {
                display: none !important; /* éšè—è§’è‰²å¡ç‰‡ */
            }
            
            .gacha-right {
                padding: 12px;
            }
            
            .event-title {
                font-size: 1.4rem;
            }
            
            .event-time {
                font-size: 0.8rem;
            }
            
            .event-highlight {
                font-size: 1rem;
            }
            
            .event-desc {
                font-size: 0.8rem;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .gacha-btn {
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
            }
            
            .gacha-arrow {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .card {
                cursor: default;
            }
            
            .drawing-btn {
                min-height: 44px;
            }
            
            /* å¢åŠ è§¦æ‘¸åé¦ˆ */
            .gacha-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
            
            .gacha-arrow:active {
                background-color: rgba(144, 202, 249, 0.2);
                border-radius: 50%;
            }
        }
        
        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 600px) {
            .gacha-main {
                margin: 10px auto 0 auto;
            }
            
            .gacha-character img {
                width: 120px;
                height: 150px;
            }
            
            .gacha-right {
                padding: 15px;
            }
            
            .event-title {
                font-size: 1.2rem;
            }
            
            .event-time {
                font-size: 0.8rem;
            }
            
            .event-highlight {
                font-size: 0.9rem;
            }
            
            .event-desc {
                font-size: 0.8rem;
            }
            
            .gacha-bottom {
                margin: 10px auto 0 auto;
            }
            
            .container {
                margin-bottom: 10px;
            }
        }
        
        /* é«˜åˆ†è¾¨ç‡å±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .card-image {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
            
            .gacha-character img {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        .top-bar {
            width: 100%;
            height: 48px;
            background: #e3f2fd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(74,109,167,0.08);
            padding: 0 32px;
            font-size: 1.1rem;
            user-select: none;
        }
        .top-left, .top-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .energy { color: #43a047; font-weight: bold; }
        .coin { color: #fbc02d; font-weight: bold; }
        .gem { color: #039be5; font-weight: bold; }
        .icon { margin-left: 4px; }
        .plus-icon::before { content: '+'; color: #90caf9; font-size: 1.3em; }
        .settings-icon::before { content: '\2699'; color: #789; font-size: 1.3em; }
        .energy-icon::before { content: '\26A1'; color: #43a047; }
        .coin-icon::before { content: '\1F4B0'; }
        .gem-icon::before { content: '\1F48E'; }
        
        /* é¡¶éƒ¨æ ä¸­çš„point-boxæ ·å¼è°ƒæ•´ */
        .top-bar .point-box {
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
            padding: 4px 12px;
            color: #1976d2;
            font-weight: bold;
            font-size: 0.9rem;
            border: 1px solid #90caf9;
        }

        .gacha-main {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 32px auto 0 auto;
            max-width: 1100px;
            width: 100%;
            min-height: 420px;
        }
        .gacha-left {
            flex: 1.2;
            display: flex;
            align-items: center;
            position: relative;
            min-width: 420px;
        }
        .gacha-arrow {
            font-size: 2.2rem;
            color: #90caf9;
            cursor: pointer;
            user-select: none;
            padding: 0 12px;
            transition: color 0.2s;
        }
        .gacha-arrow:hover { color: #1976d2; }
        .gacha-character {
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(74,109,167,0.10);
            padding: 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 320px;
        }
        .gacha-character img {
            width: 260px;
            height: 320px;
            object-fit: contain;
            border-radius: 12px;
            background: #e3f2fd;
            margin-bottom: 12px;
        }
        .character-info {
            text-align: center;
        }
        .star {
            color: #ffd700;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .name {
            color: #263238;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .cv {
            color: #789;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        .gacha-right {
            flex: 1;
            background: rgba(255,255,255,0.97);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(74,109,167,0.10);
            margin-left: 32px;
            padding: 32px 28px 24px 28px;
            min-width: 340px;
        }
        .event-title {
            color: #1976d2;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-time {
            color: #789;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        .event-highlight {
            color: #0288d1;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-highlight .blue { color: #1976d2; }
        .event-desc {
            color: #333;
            font-size: 1rem;
            line-height: 1.6;
        }
        .gacha-bottom {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin: 32px auto 0 auto;
            max-width: 900px;
            width: 100%;
        }
        .point-box {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 8px 18px;
            color: #1976d2;
            font-weight: bold;
            font-size: 1.1rem;
            border: 1.5px solid #90caf9;
        }
        .gacha-btn {
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 12px 32px;
            margin: 0 4px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(74,109,167,0.08);
            transition: background 0.2s, color 0.2s, transform 0.1s;
        }
        .gacha-btn.single {
            background: linear-gradient(90deg, #e3f2fd 60%, #b3e5fc 100%);
            color: #1976d2;
        }
        .gacha-btn.multi {
            background: linear-gradient(90deg, #fffde7 60%, #ffe082 100%);
            color: #fbc02d;
        }
        .gacha-btn.select {
            background: #e3f2fd;
            color: #1976d2;
        }
        .gacha-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.08);
        }
        .gacha-btn:active {
            transform: scale(0.96);
            box-shadow: 0 1px 2px rgba(74,109,167,0.18);
            filter: brightness(0.96);
        }
        @media (max-width: 900px) {
            .gacha-main { flex-direction: column; align-items: center; }
            .gacha-right { margin-left: 0; margin-top: 24px; }
        }
        @media (max-width: 600px) {
            .gacha-main { flex-direction: column; }
            .gacha-left, .gacha-right { min-width: 0; width: 100%; }
            .gacha-character img { width: 90vw; height: auto; }
        }
        .gacha-result-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .gacha-result-content {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(74,109,167,0.18);
            padding: 32px 36px 24px 36px;
            min-width: 340px;
            max-width: 90vw;
            text-align: center;
            position: relative;
        }
        .gacha-result-title {
            color: #1976d2;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 18px;
        }
        .gacha-result-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-bottom: 18px;
        }
        .gacha-result-card {
            background: #f5fafd;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(74,109,167,0.10);
            width: 110px;
            padding: 8px 8px 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            animation: cardAppear 0.5s;
        }
        .gacha-result-card img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: #e3f2fd;
        }
        .gacha-result-card .star {
            color: #ffd700;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .gacha-result-card .name {
            color: #263238;
            font-size: 1rem;
            font-weight: bold;
        }
        .gacha-result-card .type {
            color: #789;
            font-size: 0.9rem;
        }
        .gacha-result-close {
            position: absolute;
            top: 10px; right: 18px;
            font-size: 1.5rem;
            color: #789;
            background: none;
            border: none;
            cursor: pointer;
        }
        .gacha-result-close:hover { color: #1976d2; }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="top-bar">
        <div class="top-left">
            <span class="gem">è”šè“æ¡£æ¡ˆæŠ½å¡æ¨¡æ‹Ÿå™¨</span>
        </div>
        <div class="top-right">
            <span class="point-box">BigJackson <span class="point-value">åˆ¶ä½œ</span></span>
        </div>
    </div>
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="gacha-main">
        <!-- å·¦ä¾§è§’è‰²å¤§å›¾å’Œä¿¡æ¯ -->
        <div class="gacha-left">
            <div class="gacha-arrow left" id="prevBanner">&#8592;</div>
            <div class="gacha-character">
                <img id="characterImage" src="https://baimg.bigjackson.top/img/ailisi.png" alt="è§’è‰²å¤§å›¾">
                <div class="character-info">
                    <div class="star">â˜…â˜…â˜…</div>
                    <div class="name">çˆ±ä¸½ä¸</div>
                    <div class="cv">é…éŸ³ ç”°ä¸­ç¾æµ·</div>
                </div>
            </div>
            <div class="gacha-arrow right" id="nextBanner">&#8594;</div>
        </div>
        <!-- å³ä¾§æ´»åŠ¨ä¿¡æ¯ -->
        <div class="gacha-right">
            <div class="event-title">åº†å…¸æ‹›å‹Ÿï¼</div>
            <div class="event-time">2025/06/28 14:00~2025/08/28 13:59æˆªæ­¢</div>
            <div class="event-highlight"><span class="blue">çˆ±ä¸½ä¸ï¼ˆ3â˜…ï¼‰</span> æ‹›å‹Ÿæ¦‚ç‡æå‡ï¼</div>
            <div class="event-desc">é€‰æ‹©æ‹›å‹Ÿ10æ¬¡ï¼Œå¿…å®šè·å¾—1å2â˜…ä»¥ä¸Šæˆå‘˜ï¼<br>â€»è‹¥å‡ºç°å·²æ‹¥æœ‰çš„æˆå‘˜åˆ™ä¼šè½¬æ¢ä¸ºç¥åç²¾é«“ä¸è¯¥æˆå‘˜çš„ç¥åå­—ã€‚</div>
        </div>
    </div>
    <!-- åº•éƒ¨æ“ä½œåŒº -->
    <div class="gacha-bottom">
        <button class="gacha-btn single">æ‹›å‹Ÿ1æ¬¡</button>
        <button class="gacha-btn multi">æ‹›å‹Ÿ10æ¬¡</button>
        <button class="gacha-btn history" style="background: linear-gradient(90deg, #f3e5f5 60%, #e1bee7 100%); color: #7b1fa2;">å†å²è®°å½•</button>
        <button class="gacha-btn reset" style="background: linear-gradient(90deg, #ffebee 60%, #ffcdd2 100%); color: #d32f2f;" onclick="resetGameData()">é‡ç½®æ•°æ®</button>
    </div>
    
    <!-- æŠ½å¡ç»Ÿè®¡åŒºåŸŸ -->
    <div class="container">
        <h2 style="text-align: center; color: #4a6da7; margin-bottom: 20px;">æŠ½å¡ç»Ÿè®¡</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="pullCount">0</div>
                <div class="stat-label">æ€»æŠ½å¡æ¬¡æ•°</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="threeStarCount">0</div>
                <div class="stat-label">3â˜…å­¦ç”Ÿ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="twoStarCount">0</div>
                <div class="stat-label">2â˜…å­¦ç”Ÿ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="oneStarCount">0</div>
                <div class="stat-label">1â˜…å­¦ç”Ÿ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="newStudentCount">0</div>
                <div class="stat-label">æ–°å­¦ç”Ÿ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="pityCount">0</div>
                <div class="stat-label">ä¿åº•è¿›åº¦</div>
            </div>
        </div>
        
        <!-- æ¦‚ç‡ä¿¡æ¯ -->
        <div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(74, 109, 167, 0.05); border-radius: 10px;">
            <h3 style="color: #4a6da7; margin-bottom: 10px;">å½“å‰æ¦‚ç‡</h3>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                <div>
                    <span style="color: #ffd700; font-weight: bold;">3â˜…æ¦‚ç‡: 7.5%</span>
                    <br><small style="color: #666;">ä¿åº•: 200æŠ½</small>
                </div>
                <div>
                    <span style="color: #b39ddb; font-weight: bold;">2â˜…æ¦‚ç‡: 18.5%</span>
                </div>
                <div>
                    <span style="color: #a5d6a7; font-weight: bold;">1â˜…æ¦‚ç‡: 74%</span>
                </div>
            </div>
        </div>
        
        <!-- æŠ½å¡ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="results" id="results"></div>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>æ‹›å‹Ÿä¸­...</h3>
        </div>
    </div>
    
    <!-- ç”»æ¿ -->
    <div class="drawing-panel" id="drawingPanel">
        <div class="drawing-container">
            <div class="drawing-canvas-container">
                <canvas id="drawingCanvas" width="600" height="400"></canvas>
            </div>
            
            <div class="drawing-buttons">
                <button class="drawing-btn" id="clearCanvas">ğŸ—‘ï¸ æ¸…ç©ºç”»æ¿</button>
                <button class="drawing-btn" id="finishDrawing">âœ¨ å®Œæˆç»˜åˆ¶å¹¶æŠ½å¡</button>
                <button class="drawing-btn" id="cancelDrawing">âŒ å–æ¶ˆç»˜åˆ¶</button>
            </div>
        </div>
    </div>
    
    <!-- æŠ½å¡ç»“æœå¼¹çª— -->
    <div class="gacha-result-modal" id="gachaResultModal">
        <div class="gacha-result-content">
            <button class="gacha-result-close" id="closeGachaResult">Ã—</button>
            <div class="gacha-result-title" id="gachaResultTitle">æŠ½å¡ç»“æœ</div>
            <div class="gacha-result-cards" id="gachaResultCards"></div>
        </div>
    </div>
    
    <!-- æŠ½å¡å†å²è®°å½•å¼¹çª— -->
    <div class="gacha-result-modal" id="historyModal">
        <div class="gacha-result-content" style="max-height: 80vh; overflow-y: auto;">
            <button class="gacha-result-close" id="closeHistory">Ã—</button>
            <div class="gacha-result-title">æŠ½å¡å†å²è®°å½•</div>
            <div id="historyContent"></div>
        </div>
    </div>
    
    <audio id="gachaSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3" preload="auto"></audio>
    <audio id="rareSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
    
    <script>
        // å­¦ç”Ÿæ•°æ®
        const students = [
            // 3â˜…å­¦ç”Ÿ
            { id: 1, name: "é˜¿éœ²", type: "æ”»å‡»", rarity: 3, image: "https://baimg.bigjackson.top/img/alu.jpg", new: false },
            { id: 2, name: "ç™½å­", type: "æ”»å‡»", rarity: 3, image: "https://baimg.bigjackson.top/img/baizi.png", new: false },
            { id: 3, name: "æ—¥å¯Œç¾", type: "æ²»ç–—", rarity: 3, image: "https://baimg.bigjackson.top/img/rifumei.png", new: false },
            { id: 4, name: "ä¼˜é¦™", type: "é˜²å¾¡", rarity: 3, image: "https://baimg.bigjackson.top/img/youxiang.png", new: false },
            { id: 5, name: "æ˜Ÿé‡", type: "é˜²å¾¡", rarity: 3, image: "https://baimg.bigjackson.top/img/xingye.png", new: false },
            { id: 6, name: "åƒä¸–", type: "è¾…åŠ©", rarity: 3, image: "https://baimg.bigjackson.top/img/qianshi.png", new: false },
            { id: 7, name: "æ˜æ—¥å¥ˆ", type: "é˜²å¾¡", rarity: 3, image: "https://baimg.bigjackson.top/img/mingrinai.png", new: false },
            { id: 8, name: "èŠ±å‡›", type: "è¾…åŠ©", rarity: 3, image: "https://baimg.bigjackson.top/img/hualing.png", new: false },
            { id: 9, name: "ç¦æœˆ", type: "æ”»å‡»", rarity: 3, image: "https://baimg.bigjackson.top/img/xiyue.png", new: false },
            { id: 10, name: "èŠ¹é¦™", type: "æ”»å‡»", rarity: 3, image: "https://baimg.bigjackson.top/img/qinxiang.png", new: false },
            { id: 11, name: "äºšå­", type: "è¾…åŠ©", rarity: 3, image: "https://baimg.bigjackson.top/img/yazi.png", new: false },
            
            // 2â˜…å­¦ç”Ÿ
            { id: 12, name: "å°ç‰", type: "è¾…åŠ©", rarity: 2, image: "https://baimg.bigjackson.top/img/xiaoyu.png", new: false },
            { id: 13, name: "ç»¿", type: "è¾…åŠ©", rarity: 2, image: "https://baimg.bigjackson.top/img/lv.png", new: false },
            { id: 14, name: "èŒœ", type: "æ²»ç–—", rarity: 2, image: "https://baimg.bigjackson.top/img/xi.png", new: false },
            { id: 15, name: "æ¡ƒäº•", type: "æ”»å‡»", rarity: 2, image: "https://baimg.bigjackson.top/img/taojing.png", new: false },
            { id: 16, name: "é‡å®«", type: "æ”»å‡»", rarity: 2, image: "https://baimg.bigjackson.top/img/yegong.png", new: false },
            { id: 17, name: "åƒå¤", type: "é˜²å¾¡", rarity: 2, image: "https://baimg.bigjackson.top/img/qianxia.png", new: false },
            { id: 18, name: "ä½³ä»£å­", type: "æ”»å‡»", rarity: 2, image: "https://baimg.bigjackson.top/img/jiadaizi.png", new: false },
            { id: 19, name: "é“ƒç¾", type: "æ²»ç–—", rarity: 2, image: "https://baimg.bigjackson.top/img/lingmei.png", new: false },
            { id: 20, name: "è²è§", type: "æ”»å‡»", rarity: 2, image: "https://baimg.bigjackson.top/img/lianjian.png", new: false },
            { id: 21, name: "æ³‰", type: "æ”»å‡»", rarity: 2, image: "https://baimg.bigjackson.top/img/quan.png", new: false },
            
            // 1â˜…å­¦ç”Ÿ
            { id: 22, name: "çˆ±ä¸½ä¸", type: "æ”»å‡»", rarity: 1, image: "https://baimg.bigjackson.top/img/ailisi.png", new: false },
            { id: 23, name: "å°æ˜¥", type: "è¾…åŠ©", rarity: 1, image: "https://baimg.bigjackson.top/img/xiaocun.png", new: false },
            { id: 24, name: "å°æ»¡", type: "é˜²å¾¡", rarity: 1, image: "https://baimg.bigjackson.top/img/xiaoman.png", new: false },
            { id: 25, name: "å°æ¡ƒ", type: "æ”»å‡»", rarity: 1, image: "https://baimg.bigjackson.top/img/taojing.png", new: false },
            { id: 26, name: "å°ç»¿", type: "è¾…åŠ©", rarity: 1, image: "https://baimg.bigjackson.top/img/lv.png", new: false }
        ];

        // æ¸¸æˆçŠ¶æ€
        const state = {
            pullCount: 0,
            threeStarCount: 0,
            twoStarCount: 0,
            oneStarCount: 0,
            newStudentCount: 0,
            ownedStudents: [],
            currentPullCount: 0, // å½“å‰è¦è¿›è¡Œçš„æŠ½å¡æ¬¡æ•°
            pityCount: 0, // ä¿åº•è®¡æ•°å™¨
            lastPullResults: [], // æœ€è¿‘ä¸€æ¬¡æŠ½å¡ç»“æœ
            pullHistory: [] // æŠ½å¡å†å²è®°å½•
        };

        // DOMå…ƒç´ 
        const resultsEl = document.getElementById('results');
        const singlePullBtn = document.getElementById('singlePull');
        const multiPullBtn = document.getElementById('multiPull');
        const loadingEl = document.getElementById('loading');
        const gachaSound = document.getElementById('gachaSound');
        const rareSound = document.getElementById('rareSound');
        const pullCountEl = document.getElementById('pullCount');
        const threeStarCountEl = document.getElementById('threeStarCount');
        const twoStarCountEl = document.getElementById('twoStarCount');
        const oneStarCountEl = document.getElementById('oneStarCount');
        const newStudentCountEl = document.getElementById('newStudentCount');
        
        // ç”»æ¿ç›¸å…³å…ƒç´ 
        const drawingPanel = document.getElementById('drawingPanel');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const finishDrawingBtn = document.getElementById('finishDrawing');
        const cancelDrawingBtn = document.getElementById('cancelDrawing');

        // ç”»æ¿å˜é‡
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#87CEEB';
        let currentBrushSize = 3;

        // åˆå§‹åŒ–ç”»æ¿
        function initDrawingPanel() {
            const ctx = drawingCanvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒèƒŒæ™¯ä¸ºç™½è‰²
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            
            // äº‹ä»¶ç›‘å¬
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
            
            // è§¦æ‘¸æ”¯æŒ - é‡å†™è§¦æ‘¸äº‹ä»¶å¤„ç†
            drawingCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            drawingCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            drawingCanvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            drawingCanvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
            
            // æŒ‰é’®äº‹ä»¶
            finishDrawingBtn.addEventListener('click', finishDrawing);
            cancelDrawingBtn.addEventListener('click', cancelDrawing);
            document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
        }

        // å¼€å§‹ç»˜åˆ¶
        function startDrawing(e) {
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            
            // è®¡ç®—ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            
            lastX = (e.clientX - rect.left) * scaleX;
            lastY = (e.clientY - rect.top) * scaleY;
        }

        // ç»˜åˆ¶ä¸­
        function draw(e) {
            if (!isDrawing) return;
            
            const ctx = drawingCanvas.getContext('2d');
            const rect = drawingCanvas.getBoundingClientRect();
            
            // è®¡ç®—ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentBrushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        // åœæ­¢ç»˜åˆ¶
        function stopDrawing() {
            isDrawing = false;
        }

        // è§¦æ‘¸å¼€å§‹ - é‡å†™
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            
            // è®¡ç®—ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            
            isDrawing = true;
            lastX = (touch.clientX - rect.left) * scaleX;
            lastY = (touch.clientY - rect.top) * scaleY;
        }

        // è§¦æ‘¸ç§»åŠ¨ - é‡å†™
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            const ctx = drawingCanvas.getContext('2d');
            
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentBrushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        // è§¦æ‘¸ç»“æŸ - é‡å†™
        function handleTouchEnd(e) {
            e.preventDefault();
            isDrawing = false;
        }

        // å®Œæˆç»˜åˆ¶å¹¶æŠ½å¡
        function finishDrawing() {
            // æ£€æŸ¥æ˜¯å¦ç”»äº†å†…å®¹
            const ctx = drawingCanvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height);
            const data = imageData.data;
            
            let nonWhitePixels = 0;
            for (let i = 0; i < data.length; i += 4) {
                // æ£€æŸ¥åƒç´ æ˜¯å¦ä¸æ˜¯ç™½è‰²
                if (data[i] !== 255 || data[i+1] !== 255 || data[i+2] !== 255) {
                    nonWhitePixels++;
                }
            }
            
            if (nonWhitePixels < 100) {
                // æ˜¾ç¤ºæ›´å‹å¥½çš„æç¤ºï¼Œè€Œä¸æ˜¯alert
                showDrawingHint();
                return;
            }
            
            drawingPanel.style.display = 'none';
            
            // è®¡ç®—è¿æ°”å€¼ï¼ˆåŸºäºç»˜åˆ¶å†…å®¹çš„å¤æ‚åº¦å’Œæ•°é‡ï¼‰
            const complexity = calculateDrawingComplexity(imageData);
            const luckBonus = Math.min(8, Math.floor(complexity / 1000) + Math.floor(nonWhitePixels / 500));
            
            // ç›´æ¥æ‰§è¡ŒæŠ½å¡ï¼Œä¸æ˜¾ç¤ºalert
            doPull(state.currentPullCount, luckBonus);
            
            // æ¸…ç©ºç”»æ¿
            clearCanvas();
        }
        
        // æ˜¾ç¤ºç»˜åˆ¶æç¤º
        function showDrawingHint() {
            const hintDiv = document.createElement('div');
            hintDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #ff9a9e, #fad0c4);
                color: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                max-width: 400px;
                text-align: center;
                font-size: 1.1rem;
                line-height: 1.5;
            `;
            
            hintDiv.innerHTML = `
                <h3 style="margin-bottom: 15px; font-size: 1.3rem;">ğŸ¨ è¯·ç»§ç»­ç»˜åˆ¶</h3>
                <p>è¯·åœ¨ç”»æ¿ä¸Šç»˜åˆ¶æ›´å¤šå†…å®¹å“¦ï¼</p>
                <p><strong>ğŸ’¡ å»ºè®®ï¼š</strong></p>
                <p>â€¢ å†™"æƒ³è¦3æ˜Ÿ"ã€"æ¬§æ°”æ»¡æ»¡"ç­‰ç¥ˆæ„¿æ–‡å­—</p>
                <p>â€¢ ç”»å¾—è¶Šè®¤çœŸï¼Œè¿æ°”åŠ æˆè¶Šé«˜ï¼</p>
                <button onclick="this.parentElement.remove()" style="
                    background: white;
                    color: #ff9a9e;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 1rem;
                    font-weight: bold;
                    cursor: pointer;
                    margin-top: 15px;
                ">çŸ¥é“äº†</button>
            `;
            
            document.body.appendChild(hintDiv);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (hintDiv.parentElement) {
                    hintDiv.remove();
                }
            }, 3000);
        }

        // è®¡ç®—ç»˜åˆ¶å¤æ‚åº¦
        function calculateDrawingComplexity(imageData) {
            const data = imageData.data;
            let complexity = 0;
            let colorChanges = 0;
            let lastColor = null;
            
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] !== 255 || data[i+1] !== 255 || data[i+2] !== 255) {
                    const currentColor = data[i] + ',' + data[i+1] + ',' + data[i+2];
                    if (lastColor && lastColor !== currentColor) {
                        colorChanges++;
                    }
                    lastColor = currentColor;
                    complexity++;
                }
            }
            
            return complexity + colorChanges * 10;
        }

        // å–æ¶ˆç»˜åˆ¶
        function cancelDrawing() {
            drawingPanel.style.display = 'none';
            clearCanvas();
        }

        // æ˜¾ç¤ºç”»æ¿
        function showDrawingPanel(pullCount) {
            state.currentPullCount = pullCount;
            drawingPanel.style.display = 'flex';
            clearCanvas();
        }

        // æ¸…ç©ºç”»æ¿å‡½æ•°
        function clearCanvas() {
            const ctx = drawingCanvas.getContext('2d');
            const w = drawingCanvas.width;
            const h = drawingCanvas.height;
            // å…ˆå¡«å……ç™½è‰²åº•
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);
            // ç»˜åˆ¶è“ç™½æ–œæ¡çº¹
            const stripeWidth = 24; // æ¡çº¹å®½åº¦
            ctx.save();
            ctx.rotate(-Math.PI / 8); // è½»å¾®å€¾æ–œ
            for (let i = -h; i < w * 2; i += stripeWidth * 2) {
                ctx.fillStyle = '#b3e5fc'; // æµ…è“è‰²
                ctx.fillRect(i, 0, stripeWidth, h * 2);
            }
            ctx.restore();
        }

        // åˆå§‹åŒ–
        function init() {
            loadGameData(); // åŠ è½½ä¿å­˜çš„æ•°æ®
            updateStats();
            initDrawingPanel();
        }
        
        // ä¿å­˜æ¸¸æˆæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveGameData() {
            const gameData = {
                state: state,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('baGachaData', JSON.stringify(gameData));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®
        function loadGameData() {
            const savedData = localStorage.getItem('baGachaData');
            if (savedData) {
                try {
                    const gameData = JSON.parse(savedData);
                    // åˆå¹¶ä¿å­˜çš„çŠ¶æ€æ•°æ®
                    Object.assign(state, gameData.state);
                    console.log('æ¸¸æˆæ•°æ®å·²åŠ è½½');
                } catch (error) {
                    console.error('åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥:', error);
                }
            }
        }
        
        // é‡ç½®æ¸¸æˆæ•°æ®
        function resetGameData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ½å¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                state.pullCount = 0;
                state.threeStarCount = 0;
                state.twoStarCount = 0;
                state.oneStarCount = 0;
                state.newStudentCount = 0;
                state.ownedStudents = [];
                state.pityCount = 0;
                state.lastPullResults = [];
                state.pullHistory = [];
                
                // æ¸…ç©ºæ˜¾ç¤º
                document.getElementById('results').innerHTML = '';
                updateStats();
                
                // ä¿å­˜é‡ç½®åçš„æ•°æ®
                saveGameData();
                
                alert('æ¸¸æˆæ•°æ®å·²é‡ç½®ï¼');
            }
        }

        // æ‰§è¡ŒæŠ½å¡
        function doPull(count, luckBonus = 0) {
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loadingEl.style.display = 'flex';
            
            // æ’­æ”¾éŸ³æ•ˆ
            gachaSound.currentTime = 0;
            gachaSound.play();
            
            // æ¸…ç©ºç»“æœ
            resultsEl.innerHTML = '';
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            setTimeout(() => {
                const results = [];
                let hasRare = false;
                
                for (let i = 0; i < count; i++) {
                    const student = pullStudent(luckBonus);
                    results.push(student);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰3æ˜Ÿ
                    if (student.rarity === 3) {
                        hasRare = true;
                    }
                }
                
                // å¦‚æœæœ‰3æ˜Ÿï¼Œæ’­æ”¾ç¨€æœ‰éŸ³æ•ˆ
                if (hasRare) {
                    rareSound.currentTime = 0;
                    rareSound.play();
                }
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(results);
                
                // æ›´æ–°çŠ¶æ€
                updateStats();
                
                // éšè—åŠ è½½åŠ¨ç”»
                loadingEl.style.display = 'none';
            }, 1500);
        }

        // æŠ½å–ä¸€ä¸ªå­¦ç”Ÿï¼ˆè€ƒè™‘è¿æ°”åŠ æˆå’Œä¿åº•æœºåˆ¶ï¼‰
        function pullStudent(luckBonus = 0) {
            const random = Math.random() * 100;
            let rarity;
            
            // ä¿åº•æœºåˆ¶ï¼šå¦‚æœå·²ç»æŠ½äº†199æ¬¡æ²¡æœ‰3æ˜Ÿï¼Œç¬¬200æ¬¡å¿…å®š3æ˜Ÿ
            if (state.pityCount >= 199) {
                rarity = 3;
                state.pityCount = 0; // é‡ç½®ä¿åº•è®¡æ•°å™¨
            } else {
                // åŸºç¡€æ¦‚ç‡: 3â˜… 7.5% (åŒå€UP), 2â˜… 18.5%, 1â˜… 74%
                // åŠ ä¸Šè¿æ°”åŠ æˆï¼ˆæœ€å¤šå¢åŠ 8%çš„3æ˜Ÿæ¦‚ç‡ï¼‰
                const threeStarChance = 7.5 + luckBonus;
                const twoStarChance = 18.5;
                
                if (random < threeStarChance) {
                    rarity = 3;
                    state.pityCount = 0; // æŠ½åˆ°3æ˜Ÿé‡ç½®ä¿åº•è®¡æ•°å™¨
                } else if (random < threeStarChance + twoStarChance) {
                    rarity = 2;
                    state.pityCount++; // å¢åŠ ä¿åº•è®¡æ•°å™¨
                } else {
                    rarity = 1;
                    state.pityCount++; // å¢åŠ ä¿åº•è®¡æ•°å™¨
                }
            }
            
            // è¿‡æ»¤å¯¹åº”ç¨€æœ‰åº¦çš„å­¦ç”Ÿ
            const pool = students.filter(s => s.rarity === rarity);
            const student = {...pool[Math.floor(Math.random() * pool.length)]};
            
            // æ£€æŸ¥æ˜¯å¦æ–°å­¦ç”Ÿ
            const isNew = !state.ownedStudents.includes(student.id);
            if (isNew) {
                state.ownedStudents.push(student.id);
                student.new = true;
                state.newStudentCount++;
            }
            
            // æ›´æ–°ç»Ÿè®¡
            state.pullCount++;
            if (rarity === 3) state.threeStarCount++;
            if (rarity === 2) state.twoStarCount++;
            if (rarity === 1) state.oneStarCount++;
            
            return student;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            // æŒ‰ç¨€æœ‰åº¦æ’åº (3â˜…åœ¨å‰)
            results.sort((a, b) => b.rarity - a.rarity);
            
            // ä¸ºæ¯ä¸ªç»“æœåˆ›å»ºå¡ç‰‡
            results.forEach((student, index) => {
                setTimeout(() => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.1}s`;
                    
                    card.innerHTML = `
                        <div class="card-image" style="background-image: url('${student.image}')">
                            ${student.new ? '<div class="new-student">NEW</div>' : ''}
                            <div class="card-rarity rarity-${student.rarity}">${student.rarity}â˜…</div>
                        </div>
                        <div class="card-info">
                            <div class="card-name">${student.name}</div>
                            <div class="card-type">${student.type}</div>
                        </div>
                    `;
                    
                    resultsEl.appendChild(card);
                }, index * 100);
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            pullCountEl.textContent = state.pullCount;
            threeStarCountEl.textContent = state.threeStarCount;
            twoStarCountEl.textContent = state.twoStarCount;
            oneStarCountEl.textContent = state.oneStarCount;
            newStudentCountEl.textContent = state.newStudentCount;
            document.getElementById('pityCount').textContent = state.pityCount;
        }

        // å‡æ•°æ®ï¼šå¡æ± /è§’è‰²åˆ—è¡¨
        const banners = [
            {
                name: "çˆ±ä¸½ä¸",
                star: 3,
                cv: "ç”°ä¸­ç¾æµ·",
                image: "https://baimg.bigjackson.top/img/ailisi.png",
                eventTitle: "åº†å…¸æ‹›å‹Ÿï¼",
                eventTime: "2024/02/08 14:00~2024/02/13 13:59æˆªæ­¢",
                eventHighlight: "<span class='blue'>çˆ±ä¸½ä¸ï¼ˆ3â˜…ï¼‰</span> æ‹›å‹Ÿæ¦‚ç‡æå‡ï¼",
                eventDesc: "é€‰æ‹©æ‹›å‹Ÿ10æ¬¡ï¼Œå¿…å®šè·å¾—1å2â˜…ä»¥ä¸Šæˆå‘˜ï¼<br>â€»è‹¥å‡ºç°å·²æ‹¥æœ‰çš„æˆå‘˜åˆ™ä¼šè½¬æ¢ä¸ºç¥åç²¾é«“ä¸è¯¥æˆå‘˜çš„ç¥åå­—ã€‚"
            },
            {
                name: "æ˜Ÿé‡",
                star: 3,
                cv: "èŠ±å®ˆç”±ç¾é‡Œ",
                image: "https://baimg.bigjackson.top/img/xingye.png",
                eventTitle: "å°é¸Ÿæ¸¸æ˜Ÿé‡",
                eventTime: "2024/03/01 14:00~2024/03/10 13:59æˆªæ­¢",
                eventHighlight: "<span class='blue'>æ˜Ÿé‡ï¼ˆ3â˜…ï¼‰</span> æ‹›å‹Ÿæ¦‚ç‡æå‡ï¼",
                eventDesc: "é€‰æ‹©æ‹›å‹Ÿ10æ¬¡ï¼Œå¿…å®šè·å¾—1å2â˜…ä»¥ä¸Šæˆå‘˜ï¼<br>â€»è‹¥å‡ºç°å·²æ‹¥æœ‰çš„æˆå‘˜åˆ™ä¼šè½¬æ¢ä¸ºç¥åç²¾é«“ä¸è¯¥æˆå‘˜çš„ç¥åå­—ã€‚"
            },
            {
                name: "äºšå­",
                star: 3,
                cv: "é«˜é‡éº»é‡Œä½³",
                image: "https://baimg.bigjackson.top/img/yazi.png",
                eventTitle: "ä¼Šç»‡é™æ—¶æ‹›å‹Ÿï¼",
                eventTime: "2024/03/15 14:00~2024/03/22 13:59æˆªæ­¢",
                eventHighlight: "<span class='blue'>å¤©é›¨äºšå­</span> æ‹›å‹Ÿæ¦‚ç‡æå‡ï¼",
                eventDesc: "é€‰æ‹©æ‹›å‹Ÿ10æ¬¡ï¼Œå¿…å®šè·å¾—1å2â˜…ä»¥ä¸Šæˆå‘˜ï¼<br>â€»è‹¥å‡ºç°å·²æ‹¥æœ‰çš„æˆå‘˜åˆ™ä¼šè½¬æ¢ä¸ºç¥åç²¾é«“ä¸è¯¥æˆå‘˜çš„ç¥åå­—ã€‚"
            }
        ];
        let currentBanner = 0;

        function updateBanner() {
            const banner = banners[currentBanner];
            document.getElementById('characterImage').src = banner.image;
            document.querySelector('.character-info .star').textContent = 'â˜…'.repeat(banner.star);
            document.querySelector('.character-info .name').textContent = banner.name;
            document.querySelector('.character-info .cv').textContent = 'é…éŸ³ ' + banner.cv;
            document.querySelector('.event-title').textContent = banner.eventTitle;
            document.querySelector('.event-time').textContent = banner.eventTime;
            document.querySelector('.event-highlight').innerHTML = banner.eventHighlight;
            document.querySelector('.event-desc').innerHTML = banner.eventDesc;
        }
        document.getElementById('prevBanner').onclick = function() {
            currentBanner = (currentBanner - 1 + banners.length) % banners.length;
            updateBanner();
        };
        document.getElementById('nextBanner').onclick = function() {
            currentBanner = (currentBanner + 1) % banners.length;
            updateBanner();
        };
        // åˆå§‹åŒ–
        updateBanner();

        // åˆå§‹åŒ–åº”ç”¨
        init();

        // ç»‘å®šæ–°æŒ‰é’®
        document.querySelector('.gacha-btn.single').onclick = function() {
            showDrawingPanel(1);
        };
        document.querySelector('.gacha-btn.multi').onclick = function() {
            showDrawingPanel(10);
        };
        // å…³é—­å¼¹çª—
        document.getElementById('closeGachaResult').onclick = function() {
            document.getElementById('gachaResultModal').style.display = 'none';
        };
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('gachaResultModal').onclick = function(e) {
            if (e.target === this) this.style.display = 'none';
        };
        // å±•ç¤ºæŠ½å¡ç»“æœ
        function showGachaResult(count) {
            // æ’­æ”¾éŸ³æ•ˆ
            gachaSound.currentTime = 0;
            gachaSound.play();
            // æ‰§è¡ŒæŠ½å¡
            const results = [];
            let hasRare = false;
            for (let i = 0; i < count; i++) {
                const student = pullStudent();
                results.push(student);
                if (student.rarity === 3) hasRare = true;
            }
            if (hasRare) {
                rareSound.currentTime = 0;
                rareSound.play();
            }
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            const historyEntry = {
                timestamp: new Date(),
                count: count,
                results: results,
                hasRare: hasRare
            };
            state.pullHistory.unshift(historyEntry); // æ·»åŠ åˆ°å¼€å¤´
            state.lastPullResults = results;
            
            // æ¸²æŸ“å¡ç‰‡
            const cardsEl = document.getElementById('gachaResultCards');
            cardsEl.innerHTML = '';
            results.sort((a, b) => b.rarity - a.rarity);
            results.forEach(student => {
                const card = document.createElement('div');
                card.className = 'gacha-result-card';
                card.innerHTML = `
                    <img src="${student.image}" alt="${student.name}">
                    <div class="star">${'â˜…'.repeat(student.rarity)}</div>
                    <div class="name">${student.name}</div>
                    <div class="type">${student.type}</div>
                    ${student.new ? '<div class="new-student" style="position:absolute;top:4px;left:4px;background:#ff4081;color:#fff;padding:1px 4px;border-radius:3px;font-size:0.7rem;">NEW</div>' : ''}
                `;
                cardsEl.appendChild(card);
            });
            // æ ‡é¢˜
            document.getElementById('gachaResultTitle').textContent = count === 1 ? 'æŠ½å¡ç»“æœ' : 'åè¿æŠ½ç»“æœ';
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('gachaResultModal').style.display = 'flex';
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '';
            
            if (state.pullHistory.length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŠ½å¡è®°å½•</p>';
            } else {
                state.pullHistory.forEach((entry, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #fafafa;';
                    
                    const timeStr = entry.timestamp.toLocaleString('zh-CN');
                    const countStr = entry.count === 1 ? 'å•æŠ½' : 'åè¿æŠ½';
                    
                    historyItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #1976d2;">${countStr}</span>
                            <span style="color: #666; font-size: 0.9rem;">${timeStr}</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${entry.results.map(student => `
                                <div style="display: flex; align-items: center; gap: 5px; background: white; padding: 5px; border-radius: 5px; border: 1px solid #e0e0e0;">
                                    <img src="${student.image}" alt="${student.name}" style="width: 30px; height: 30px; border-radius: 3px;">
                                    <span style="font-size: 0.9rem;">${student.name}</span>
                                    <span style="color: ${student.rarity === 3 ? '#ffd700' : student.rarity === 2 ? '#b39ddb' : '#a5d6a7'}; font-weight: bold;">${'â˜…'.repeat(student.rarity)}</span>
                                    ${student.new ? '<span style="background: #ff4081; color: white; padding: 1px 3px; border-radius: 2px; font-size: 0.7rem;">NEW</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    historyContent.appendChild(historyItem);
                });
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        }
        
        // ç»‘å®šå†å²è®°å½•æŒ‰é’®
        document.querySelector('.gacha-btn.history').onclick = showHistory;
        
        // å…³é—­å†å²è®°å½•å¼¹çª—
        document.getElementById('closeHistory').onclick = function() {
            document.getElementById('historyModal').style.display = 'none';
        };
        
        // ç‚¹å‡»å†å²è®°å½•å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('historyModal').onclick = function(e) {
            if (e.target === this) this.style.display = 'none';
        };
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        function initMobileOptimizations() {
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // é˜²æ­¢é¡µé¢ç¼©æ”¾
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gesturechange', function (e) {
                e.preventDefault();
            });
            
            document.addEventListener('gestureend', function (e) {
                e.preventDefault();
            });
            
            // ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨
            document.addEventListener('touchmove', function (e) {
                if (e.target.closest('.drawing-panel') || e.target.closest('.gacha-result-modal')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // æ·»åŠ è§¦æ‘¸åé¦ˆ
            const buttons = document.querySelectorAll('.gacha-btn, .drawing-btn, .gacha-arrow');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
                
                button.addEventListener('touchcancel', function() {
                    this.style.transform = '';
                });
            });
            
            // æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶è°ƒæ•´UI
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
                
                // è°ƒæ•´ç”»æ¿å¤§å°ä»¥é€‚åº”ç§»åŠ¨è®¾å¤‡
                if (drawingCanvas) {
                    const maxWidth = Math.min(window.innerWidth * 0.9, 600);
                    const maxHeight = Math.min(window.innerHeight * 0.6, 400);
                    drawingCanvas.width = maxWidth;
                    drawingCanvas.height = maxHeight;
                }
            }
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
        window.addEventListener('resize', function() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && drawingCanvas) {
                const maxWidth = Math.min(window.innerWidth * 0.9, 600);
                const maxHeight = Math.min(window.innerHeight * 0.6, 400);
                drawingCanvas.width = maxWidth;
                drawingCanvas.height = maxHeight;
                clearCanvas(); // é‡æ–°æ¸…ç©ºç”»æ¿
            }
        });
        
        // åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¼˜åŒ–
        initMobileOptimizations();
        
        // å¼ºåˆ¶æ‰‹æœºç«¯éšè—è§’è‰²å¤§å›¾
        function forceHideGachaLeft() {
            const gachaLeft = document.querySelector('.gacha-left');
            if (gachaLeft && window.innerWidth <= 768) {
                gachaLeft.style.display = 'none';
                gachaLeft.style.visibility = 'hidden';
                gachaLeft.style.opacity = '0';
                gachaLeft.style.position = 'absolute';
                gachaLeft.style.left = '-9999px';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        forceHideGachaLeft();
        
        // çª—å£å¤§å°æ”¹å˜æ—¶æ‰§è¡Œ
        window.addEventListener('resize', forceHideGachaLeft);
    </script>
</body>
</html>